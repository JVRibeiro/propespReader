scanner={};(function(){for(var a=document.querySelectorAll(".mdl-layout__drawer-button"),b=0;b<a.length;b++)a[b].removeAttribute("tabindex")})();
var logIsEnabled,snapTimeout,toastTimeout,cameraGlobal,actualLiArr,actualScrollEl,actualContentEl,isCameraTabActive=!0,saved_li_arr=[],rejected_li_arr=[],qrScan={data:[],rejected:[],initHtmlElement:function(a){return document.getElementById(a)},initVideoObjectOptions:function(a){scanner={};return{video:qrScan.initHtmlElement(a),continuous:!0,mirror:!1,captureImage:!1,backgroundScan:!1,refractoryPeriod:4E3,scanPeriod:1}},initAvaliableCameras:function(a){Instascan.Camera.getCameras().then(function(b){a()})},
initCamera:function(a){scanner.stop();Instascan.Camera.getCameras().then(function(a){if(0<a.length){var b=a[0];$.each(a,function(a,c){if(-1!=c.name.indexOf("back"))return b=c,!1});scanner.start(b);cameraGlobal=b}else alert("Nenhuma camera encontrada.")})},scanStart:function(a){scanner.addListener("scan",function(b){a(b)})},saveScannedData:function(a){console.log("Iniciando verifica\u00e7\u00e3o...");var b,c,d,e;null!==a.match(/\n/g)||null!==a.match(/\\\"/g)||null!==a.match(/\s/g)?(b=a.replace(/\n/gi,
""),b=b.replace(/\\\"/g,'"'),b=b.replace(/\"\: \"/g,'":"').replace(/\", \"/g,'","').replace(/\"\: \{\"/g,'":{"')):b=a;console.log("QR Code content: "+a);console.log("QR Code processed: "+b);null!==b.match(/^\x7b\"\x70\x72\x6f\x70\x65\x73\x70\"\:\x7b(.*)\x7d\x7d/g)?(d=!0,e=!1,a=b):null===b.match(/^\{(.*)\}/g)&&null===b.match(/\s/g)&&(c=d=!0);console.log("isQRValid (pretest): "+(d?"maybe valid":"invalid"));c&&d&&(console.log("QR Code is maybe encoded. Validating..."),c=CryptoJS.AES.decrypt(b,"propespti2013"),
full_dec=c.toString(CryptoJS.enc.Utf8),e=null!==full_dec.match(/^\{(.*)\}/g)?!0:!1);e&&d?(console.log("QR Code is maybe valid!"),console.log("QR Code is encoded!"),console.log("Checking authencity..."),c=CryptoJS.AES.decrypt(b,"propespti2013"),a=c.toString(CryptoJS.enc.Utf8)):!e&&d&&(console.log("QR Code is maybe valid!"),console.log("QR Code is not encoded!"),console.log("Checking authencity..."),a=b);null!==a.match(/^\x7b\"\x70\x72\x6f\x70\x65\x73\x70\"\:\x7b(.*)\x7d\x7d/g)?(d=!0,console.log("QR Code is valid!")):
(d=!1,console.log("QR Code is invalid!"));d?(qrScan.animate._snap(),qrScan.animate._success(),qrScan.data.push(JSON.parse(a)),b=JSON.stringify(qrScan.data),a=CryptoJS.AES.encrypt(b,"propespti2013"),localStorage.setItem("data",a),qrScan.animate._showToast("Dados salvos!"),qrScan.updateHTMLArray("data"),clusterize.update(saved_li_arr)):(qrScan.animate._snap(),qrScan.animate._error(),null!==a.match(/^\{(.*)\}/g)?qrScan.rejected.push(JSON.parse(a)):qrScan.rejected.push(a),console.log("Dados rejeitados: "+
a),b=JSON.stringify(qrScan.rejected),a=CryptoJS.AES.encrypt(b,"propespti2013"),localStorage.setItem("rejected",a),qrScan.animate._showToast("QR Code inv\u00e1lido!"),qrScan.updateHTMLArray("rejected"),clusterize.update(rejected_li_arr))},loadFromLS:function(a){if("data"===a||void 0===a){var b=CryptoJS.AES.decrypt(localStorage.getItem("data"),"propespti2013").toString(CryptoJS.enc.Utf8);qrScan.data=null===localStorage.getItem("data")?qrScan.data:JSON.parse(b)}if("rejected"===a||void 0===a)a=CryptoJS.AES.decrypt(localStorage.getItem("rejected"),
"propespti2013").toString(CryptoJS.enc.Utf8),qrScan.rejected=null===localStorage.getItem("rejected")?qrScan.rejected:JSON.parse(a)},updateHTMLArray:function(a){if("data"===a||void 0===a){saved_li_arr=[];for(var b=qrScan.data.length,c=0;c<b;c++)saved_li_arr.push('<li class="mdl-list__item mdl-list__item--two-line"><span class="mdl-list__item-primary-content"><span>'+qrScan.data[c].propesp.nome+'</span><span class="mdl-list__item-sub-title">RG: '+qrScan.data[c].propesp.rg+"</span></span></li>")}if("rejected"===
a||void 0===a)for(rejected_li_arr=[],a=qrScan.rejected.length,b=0;b<a;b++)rejected_li_arr.push('<li class="mdl-list__item mdl-list__item--two-line"><span class="mdl-list__item-primary-content"><span>'+JSON.stringify(qrScan.rejected[b])+"</span></span></li>")},clearRejected:function(){localStorage.removeItem("rejected");qrScan.rejected=[];rejected_li_arr=[];qrScan.updateHTMLArray("rejected");clusterize.update(rejected_li_arr);qrScan.animate._showToast("Lista de rejeitados apagada!")},initScanner:function(a){scanner=
new Instascan.Scanner(a)},animate:{_snap:function(){$("#cameraCanvas .snap").removeClass("snap-anim");$("#cameraCanvas .snap").addClass("snap-anim").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){$("#cameraCanvas .snap").removeClass("snap-anim")})},_showToast:function(a){var b=document.querySelector(".mdl-js-snackbar");void 0!==toastTimeout&&clearTimeout(toastTimeout);$(".mdl-js-snackbar").removeClass("mdl-snackbar--active");toastTimeout=setTimeout(function(){b.MaterialSnackbar.showSnackbar({message:a})},
1100)},_success:function(){$(".error").removeClass("snap-status-in snap-status-out");void 0!==snapTimeout&&clearTimeout(snapTimeout);$(".success").removeClass("snap-status-in snap-status-out").addClass("snap-status-in");snapTimeout=setTimeout(function(){$(".success").removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){$(".success").removeClass("snap-status-out")})},3E3)},_error:function(){$(".success").removeClass("snap-status-in snap-status-out");
void 0!==snapTimeout&&clearTimeout(snapTimeout);$(".error").removeClass("snap-status-in snap-status-out").addClass("snap-status-in");snapTimeout=setTimeout(function(){$(".error").removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){$(".error").removeClass("snap-status-out")})},3E3)},_loading:function(a){a?$(".loading").css("opacity",1):$(".loading").css("opacity",0)},_pageLoaded:function(){document.getElementById("pageLoader").style.display=
"none"},_changeTab:function(a){3===a&&(actualScrollId="scrollAreaRejected",actualContentId="contentAreaRejected",actualLiArr=rejected_li_arr,qrScan.newClusterize());$("a.mdl-layout__tab").removeClass("is-active");$('a[href="#scroll-tab-'+a+'"]').addClass("is-active");$(".mdl-layout__tab-panel").removeClass("is-active");$("#scroll-tab-"+a).addClass("is-active")}},checkTab:function(a){a.href.match("#scroll-tab-1")?actualLiArr=actualContentId=actualScrollId=void 0:a.href.match("#scroll-tab-2")?(actualScrollId=
"scrollAreaSaved",actualContentId="contentAreaSaved",actualLiArr=saved_li_arr,qrScan.newClusterize()):a.href.match("#scroll-tab-3")&&(actualScrollId="scrollAreaRejected",actualContentId="contentAreaRejected",actualLiArr=rejected_li_arr,qrScan.newClusterize())},newClusterize:function(){clusterize=new Clusterize({rows:actualLiArr,tag:"ul",scrollId:actualScrollId,contentId:actualContentId,no_data_text:"Nenhum bolsista",callbacks:{clusterChanged:function(){}}})},clearHTML:function(a){document.getElementById(a).innerHTML=
""},sync:function(){document.getElementById("mdl-syncing-icon").classList.add("syncing");$.ajax({url:"./classes/retrieve_scholarship_holders.php",success:function(a){console.log(a);for(var b=0;b<qrScan.data.length;b++)for(var c=0;c<a.length;c++)if(qrScan.data[b].propesp.rg===a[c].rg){console.log("CPF de "+JSON.stringify(qrScan.data[b].propesp)+" encontrado em: "+JSON.stringify(a[c]));break}else console.log("CPF n\u00e3o encontrado!");document.getElementById("mdl-syncing-icon").classList.remove("syncing")},
error:function(){document.getElementById("mdl-syncing-icon").classList.remove("syncing");console.log("Erro ao sincronizar")}})}},clusterize=new Clusterize({rows:saved_li_arr,tag:"ul",scrollId:"scrollAreaSaved",contentId:"contentAreaSaved",no_data_text:"Nenhum bolsista",callbacks:{clusterChanged:function(){}}});null!==localStorage.getItem("data")&&(qrScan.loadFromLS("data"),qrScan.updateHTMLArray("data"));null!==localStorage.getItem("rejected")&&(qrScan.loadFromLS("rejected"),qrScan.updateHTMLArray("rejected"));
var options={},options=qrScan.initVideoObjectOptions("webcameraPreview"),cameraId=0;qrScan.initScanner(options);qrScan.initAvaliableCameras(function(){cameraId=1});qrScan.initCamera(cameraId);qrScan.scanStart(function(a){qrScan.saveScannedData(a)});scanner.addListener("active",function(){qrScan.animate._loading(!1)});scanner.addListener("inactive",function(){qrScan.animate._loading(!0)});
(function(){for(var a=document.querySelectorAll(".mdl-navigation__link"),b=document.querySelectorAll(".mdl-layout"),c=0;c<a.length;c++)a[c].addEventListener("click",function(){for(var a=0;a<b.length;a++)b[a].MaterialLayout.toggleDrawer()}),a[1].addEventListener("click",function(){qrScan.sync()}),a[2].addEventListener("click",function(){qrScan.clearRejected();setTimeout(function(){qrScan.animate._changeTab(3)},500)});$(".mdl-layout__tab").on("mousedown",function(){qrScan.checkTab(this)}).on("touchstart",
function(){qrScan.checkTab(this)}).on("click",function(){this.href.match("#scroll-tab-1")&&!isCameraTabActive?(isCameraTabActive=!0,qrScan.clearHTML("contentAreaSaved"),qrScan.clearHTML("contentAreaRejected"),scanner.start(cameraGlobal)):!this.href.match("#scroll-tab-1")&&isCameraTabActive&&(isCameraTabActive=!1,setTimeout(function(){scanner.stop()},500));this.href.match("#scroll-tab-2")?qrScan.clearHTML("contentAreaRejected"):this.href.match("#scroll-tab-3")&&qrScan.clearHTML("contentAreaSaved")})})();
