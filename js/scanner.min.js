scanner={};(function(){for(var a=document.querySelectorAll(".mdl-layout__drawer-button"),b=0;b<a.length;b++)a[b].removeAttribute("tabindex")})();
var x="propesp",logIsEnabled,snapTimeout,toastTimeout,cameraGlobal,actualLiArr,actualScrollEl,actualContentEl,isCameraTabActive=!0,saved_li_arr=[],rejected_li_arr=[],syncArr=[],qrScan={data:[],rejected:[],initHtmlElement:function(a){return document.getElementById(a)},initVideoObjectOptions:function(a){scanner={};return{video:qrScan.initHtmlElement(a),continuous:!0,mirror:!1,captureImage:!1,backgroundScan:!1,refractoryPeriod:4E3,scanPeriod:1}},initAvaliableCameras:function(a){Instascan.Camera.getCameras().then(function(b){a()})},
initCamera:function(a){scanner.stop();Instascan.Camera.getCameras().then(function(a){if(0<a.length){var b=a[0];$.each(a,function(a,c){if(-1!=c.name.indexOf("back"))return b=c,!1});scanner.start(b);cameraGlobal=b}else alert("Nenhuma camera encontrada.")})},scanStart:function(a){scanner.addListener("scan",function(b){a(b)})},saveScannedData:function(a){console.log("Iniciando verifica\u00e7\u00e3o...");var b,c,e,g;null!==a.match(/\n/g)||null!==a.match(/\\\"/g)||null!==a.match(/\s/g)?(b=a.replace(/\n/gi,
""),b=b.replace(/\\\"/g,'"'),b=b.replace(/\"\: \"/g,'":"').replace(/\", \"/g,'","').replace(/\"\: \{\"/g,'":{"')):b=a;console.log("QR Code content: "+a);console.log("QR Code processed: "+b);null!==b.match(/^\x7b\"\x70\x72\x6f\x70\x65\x73\x70\"\:\x7b(.*)\x7d\x7d/g)?(e=!0,g=!1,a=b):null===b.match(/^\{(.*)\}/g)&&null===b.match(/\s/g)&&(c=e=!0);console.log("isQRValid (pretest): "+(e?"maybe valid":"invalid"));c&&e&&(console.log("QR Code is maybe encoded. Validating..."),c=CryptoJS.AES.decrypt(b,"propespti2013"),
full_dec=c.toString(CryptoJS.enc.Utf8),g=null!==full_dec.match(/^\{(.*)\}/g)?!0:!1);g&&e?(console.log("QR Code is maybe valid!"),console.log("QR Code is encoded!"),console.log("Checking authencity..."),c=CryptoJS.AES.decrypt(b,"propespti2013"),a=c.toString(CryptoJS.enc.Utf8)):!g&&e&&(console.log("QR Code is maybe valid!"),console.log("QR Code is not encoded!"),console.log("Checking authencity..."),a=b);null!==a.match(/^\x7b\"\x70\x72\x6f\x70\x65\x73\x70\"\:\x7b(.*)\x7d\x7d/g)?(e=!0,console.log("QR Code is valid!")):
(e=!1,console.log("QR Code is invalid!"));e?(qrScan.animate._snap(),qrScan.animate._success(),qrScan.data.push(JSON.parse(a)),b=JSON.stringify(qrScan.data),a=CryptoJS.AES.encrypt(b,"propespti2013"),localStorage.setItem("data",a),qrScan.animate._showToast("Dados salvos!",1100),qrScan.updateHTMLArray("data"),qrScan.updateCluster(saved_li_arr)):(qrScan.animate._snap(),qrScan.animate._error(),null!==a.match(/^\{(.*)\}/g)?qrScan.rejected.push(JSON.parse(a)):qrScan.rejected.push(a),console.log("Dados rejeitados: "+
a),b=JSON.stringify(qrScan.rejected),a=CryptoJS.AES.encrypt(b,"propespti2013"),localStorage.setItem("rejected",a),qrScan.animate._showToast("QR Code inv\u00e1lido!",1100),qrScan.updateHTMLArray("rejected"),qrScan.updateCluster(rejected_li_arr))},loadFromLS:function(a){if("data"===a||void 0===a){var b=CryptoJS.AES.decrypt(localStorage.getItem("data"),"propespti2013").toString(CryptoJS.enc.Utf8);qrScan.data=null===localStorage.getItem("data")?qrScan.data:JSON.parse(b)}if("rejected"===a||void 0===a)a=
CryptoJS.AES.decrypt(localStorage.getItem("rejected"),"propespti2013").toString(CryptoJS.enc.Utf8),qrScan.rejected=null===localStorage.getItem("rejected")?qrScan.rejected:JSON.parse(a)},updateHTMLArray:function(a){if("data"===a||void 0===a){saved_li_arr=[];for(var b=qrScan.data.length,c=0;c<b;c++)saved_li_arr.push('<li class="mdl-list__item mdl-list__item--two-line"><div class="sh-status"><div data-cpf="'+qrScan.data[c][x].cpf+'" class="sh-status-inner"></div></div><span class="mdl-list__item-primary-content"><span>'+
qrScan.data[c][x].nome+'</span><span class="mdl-list__item-sub-title">CPF: '+qrScan.data[c][x].cpf+"</span></li>")}if("rejected"===a||void 0===a)for(rejected_li_arr=[],a=qrScan.rejected.length,b=0;b<a;b++)rejected_li_arr.push('<li class="mdl-list__item mdl-list__item--two-line"><span class="mdl-list__item-primary-content"><span>'+JSON.stringify(qrScan.rejected[b])+"</span></span></li>")},clearRejected:function(){localStorage.removeItem("rejected");qrScan.rejected=[];rejected_li_arr=[];qrScan.updateHTMLArray("rejected");
qrScan.updateCluster(rejected_li_arr);qrScan.animate._showToast("Lista de rejeitados apagada!",1100)},initScanner:function(a){scanner=new Instascan.Scanner(a)},animate:{_snap:function(){document.querySelector("#cameraCanvas .snap").classList.remove("snap-anim");$("#cameraCanvas .snap").addClass("snap-anim").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){document.querySelector("#cameraCanvas .snap").classList.remove("snap-anim")})},_showToast:function(a,b){var c=document.querySelector(".mdl-js-snackbar");
void 0==b&&(b=300);void 0!==toastTimeout&&clearTimeout(toastTimeout);document.querySelector(".mdl-js-snackbar").classList.remove("mdl-snackbar--active");toastTimeout=setTimeout(function(){c.MaterialSnackbar.showSnackbar({message:a})},b)},_success:function(){document.querySelector(".error").classList.remove("snap-status-in","snap-status-out");void 0!==snapTimeout&&clearTimeout(snapTimeout);document.querySelector(".success").classList.remove("snap-status-in","snap-status-out");document.querySelector(".success").classList.add("snap-status-in");
snapTimeout=setTimeout(function(){$(".success").removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){document.querySelector(".success").classList.remove("snap-status-out")})},3E3)},_error:function(){document.querySelector(".success").classList.remove("snap-status-in","snap-status-out");void 0!==snapTimeout&&clearTimeout(snapTimeout);document.querySelector(".error").classList.remove("snap-status-in","snap-status-out");
document.querySelector(".error").classList.add("snap-status-in");snapTimeout=setTimeout(function(){$(".error").removeClass("snap-status-in").addClass("snap-status-out").one("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(a){document.querySelector(".error").classList.remove("snap-status-out")})},3E3)},_loading:function(a){a?document.querySelector(".loading").classList.remove("transparent"):document.querySelector(".loading").classList.add("transparent")},_syncing:function(a){a?
document.getElementById("manualSync").classList.add("syncing"):document.getElementById("manualSync").classList.remove("syncing")},_changeSyncStatus:function(){var a=qrScan.data.length;setTimeout(function(){for(var b=0;b<a;b++)1===qrScan.data[b][x].synced?$('[data-cpf="'+qrScan.data[b][x].cpf+'"]').removeClass("error").addClass("synced"):2===qrScan.data[b][x].synced?$('[data-cpf="'+qrScan.data[b][x].cpf+'"]').removeClass("synced").addClass("error"):$('[data-cpf="'+qrScan.data[b][x].cpf+'"]').removeClass("synced error")},
300)},_pageLoaded:function(){document.getElementById("pageLoader").style.display="none"},_changeTab:function(a){3===a&&(actualScrollId="scrollAreaRejected",actualContentId="contentAreaRejected",actualLiArr=rejected_li_arr,qrScan.newClusterize());$("a.mdl-layout__tab").removeClass("is-active");$('a[href="#scroll-tab-'+a+'"]').addClass("is-active");$(".mdl-layout__tab-panel").removeClass("is-active");$("#scroll-tab-"+a).addClass("is-active")}},checkTab:function(a){a.href.match("#scroll-tab-1")?actualLiArr=
actualContentId=actualScrollId=void 0:a.href.match("#scroll-tab-2")?(actualScrollId="scrollAreaSaved",actualContentId="contentAreaSaved",actualLiArr=saved_li_arr,qrScan.newClusterize()):a.href.match("#scroll-tab-3")&&(actualScrollId="scrollAreaRejected",actualContentId="contentAreaRejected",actualLiArr=rejected_li_arr,qrScan.newClusterize())},newClusterize:function(){clusterize=new Clusterize({rows:actualLiArr,tag:"ul",scrollId:actualScrollId,contentId:actualContentId,no_data_text:"Nenhum bolsista"})},
updateCluster:function(a){clusterize.update(a)},clearHTML:function(a){document.getElementById(a).innerHTML=""},sync:function(){qrScan.animate._syncing(!0);qrScan.animate._showToast("Sincronizando...");$.ajax({url:"./classes/retrieve_scholarship_holders.php",success:function(a){var b,c,e,g=qrScan.data.length,h=a.length,d=0;for(;d<g;d++){1===qrScan.data[d][x].synced&&console.log("J\u00e1 sincronizado: "+qrScan.data[d][x].nome);var f=0;b:for(;f<h;f++)if(0===qrScan.data[d][x].synced||void 0===qrScan.data[d][x].synced&&
qrScan.data[d][x].nome===a[f].nome&&qrScan.data[d][x].cpf===a[f].cpf){b=!0;e=d;c=f;console.log("Encontrado: "+qrScan.data[d][x].nome);break b}else 0===qrScan.data[d][x].synced||void 0===qrScan.data[d][x].synced&&qrScan.data[d][x].nome!==a[f].nome||qrScan.data[d][x].cpf!==a[f].cpf?(b=!1,qrScan.data[d][x].synced=2):1===qrScan.data[d][x].synced?b=!1:(b=!1,qrScan.data[d][x].synced=2);b&&(syncArr.push(a[c].id),qrScan.data[e][x].synced=1,b=JSON.stringify(qrScan.data),enc=CryptoJS.AES.encrypt(b,"propespti2013"),
localStorage.setItem("data",enc),b=!1)}qrScan.animate._changeSyncStatus();qrScan.animate._syncing(!1);qrScan.animate._showToast("Sincronizado.")},error:function(){qrScan.animate._syncing(!1);qrScan.animate._showToast("Erro ao sincronizar.")}})}},clusterize=new Clusterize({rows:saved_li_arr,tag:"ul",scrollId:"scrollAreaSaved",contentId:"contentAreaSaved",no_data_text:"Nenhum bolsista",callbacks:{clusterChanged:function(){}}});null!==localStorage.getItem("data")&&(qrScan.loadFromLS("data"),qrScan.updateHTMLArray("data"));
null!==localStorage.getItem("rejected")&&(qrScan.loadFromLS("rejected"),qrScan.updateHTMLArray("rejected"));var options={},options=qrScan.initVideoObjectOptions("webcameraPreview"),cameraId=0;qrScan.initScanner(options);qrScan.initAvaliableCameras(function(){cameraId=1});qrScan.initCamera(cameraId);qrScan.scanStart(function(a){qrScan.saveScannedData(a)});scanner.addListener("active",function(){qrScan.animate._loading(!1)});scanner.addListener("inactive",function(){qrScan.animate._loading(!0)});
(function(){for(var a=document.querySelectorAll(".mdl-navigation__link"),b=document.querySelectorAll(".mdl-layout"),c=0;c<a.length;c++)a[c].addEventListener("click",function(){for(var a=0;a<b.length;a++)b[a].MaterialLayout.toggleDrawer()}),a[1].addEventListener("click",function(){qrScan.clearRejected();setTimeout(function(){qrScan.animate._changeTab(3)},500)});document.getElementById("manualSync").addEventListener("click",function(){qrScan.sync()});$(".mdl-layout__tab").on("mousedown",function(){qrScan.checkTab(this)}).on("touchstart",
function(){qrScan.checkTab(this)}).on("click",function(){this.href.match("#scroll-tab-1")&&!isCameraTabActive?(isCameraTabActive=!0,qrScan.clearHTML("contentAreaSaved"),qrScan.clearHTML("contentAreaRejected"),scanner.start(cameraGlobal)):!this.href.match("#scroll-tab-1")&&isCameraTabActive&&(isCameraTabActive=!1,setTimeout(function(){scanner.stop()},500));this.href.match("#scroll-tab-2")?qrScan.clearHTML("contentAreaRejected"):this.href.match("#scroll-tab-3")&&qrScan.clearHTML("contentAreaSaved")})})();
